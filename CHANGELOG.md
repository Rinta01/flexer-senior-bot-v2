# Changelog

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект следует [Semantic Versioning](https://semver.org/lang/ru/).

## [2.0.0] - 2026-01-21

### Основные изменения

#### Добавлено

- **Система управления активностями** - Дежурные могут устанавливать мероприятия на неделю
  - Команда `/set_activity` для установки мероприятия
  - Парсинг различных форматов дат и времени
  - Безопасность: только подтвержденный дежурный текущей недели может устанавливать активность
- **Обновленная команда `/activity`** - Показывает дежурного и активность
  - Объединенный функционал бывших команд `/duty` и `/activity`
  - Отображение диапазона дат вместо номеров недель (напр. "13 января - 19 января")
  - Статус дежурного (pending/confirmed/declined/skipped)
- **Команда `/help`** - Вынесена в отдельный модуль для лучшей поддерживаемости
- **Улучшенное отображение недель** - Удобные диапазоны дат во всех командах
- **Расширенное тестовое покрытие** - 27 тестов (было 23)
  - `test_activity_security.py` - тесты безопасности установки активностей
  - `test_activity_command.py` - тесты команды `/activity`

#### Изменено

- **Рефакторинг структуры handlers** - Улучшена модульность
  - `/duty` и `/activity` объединены в `/activity`
  - `/help` вынесен в отдельный файл
- **Обновлена документация** - Объединены все файлы документации
  - Создан `DOCUMENTATION.md` - полная документация
  - Обновлен `README.md` - краткий обзор с ссылкой на полную документацию
  - Удалены устаревшие файлы: `ACTIVITY_IMPLEMENTATION.md`, `DUTY_CONFIRMATION.md`,
    `IMPLEMENTATION_SUMMARY.md`, `AI_AGENT_GUIDE.md`, `QUICKSTART.md`,
    `DEVELOPMENT.md`, `SECURITY_VERIFICATION.md`

#### Удалено

- Команда `/duty` - функционал перенесен в `/activity`
- Файл `src/handlers/duty.py` - код объединен с `activity.py`

#### Исправлено

- Команда `/activity` теперь корректно показывает дежурных всех статусов (не только CONFIRMED)
- Параметры группы правильно преобразуются в pool_id для запросов к БД
- Импорты в `activity.py` перемещены в начало файла

### Безопасность

- Усилена безопасность команды `/set_activity`:
  - Проверка выполняется сразу после проверки типа чата
  - Многоуровневая валидация: тип чата → пул → подтвержденный дежурный → ID пользователя
  - Добавлен метод `get_current_confirmed_duty_by_group()` для правильной проверки прав

### База данных

- Добавлены поля в модель `DutyAssignment`:
  - `activity_title` - название мероприятия
  - `activity_description` - описание
  - `activity_datetime` - дата и время мероприятия
  - `activity_set_at` - когда установлено
- Новый метод репозитория: `get_duty_for_week()` - получение дежурного любого статуса

---

## [1.0.0] - 2026-01-09

### Добавлено

- **Базовая система управления дежурными**
  - Автоматический еженедельный выбор дежурного (APScheduler)
  - Система подтверждений с inline-кнопками
  - Команды: `/start`, `/join`, `/leave`, `/pool`, `/duty`, `/force_pick`
- **Архитектура Clean Architecture**
  - Handlers (обработчики команд)
  - Services (бизнес-логика)
  - Repositories (доступ к данным)
  - Models (структуры данных)
- **База данных SQLite + SQLAlchemy (async)**
  - Модели: `TelegramUser`, `DutyPool`, `UserInPool`, `DutyAssignment`
  - Async репозитории для всех CRUD операций
- **Система статусов дежурств**
  - PENDING - ожидает подтверждения
  - CONFIRMED - подтвержден
  - DECLINED - отклонен
  - SKIPPED - пропущен
- **Умная ротация без повторений**
  - Цикличность: все участники должны побывать дежурными
  - Автоматический сброс цикла при завершении
- **Тесты**
  - 23 unit и интеграционных теста
  - Покрытие основных сценариев
- **Docker поддержка**
  - `Dockerfile` и `docker-compose.yml`
  - Готовность к deployment
- **Документация**
  - README.md с инструкциями
  - QUICKSTART.md для быстрого старта
  - DEVELOPMENT.md для разработчиков

### Технологии

- Python 3.12+
- aiogram 3.24.0
- SQLAlchemy 2.0+ (async)
- aiosqlite
- APScheduler 3.11.0
- Pydantic 2.0+
- pytest + pytest-asyncio

---

## Типы изменений

- `Добавлено` - для новой функциональности
- `Изменено` - для изменений в существующей функциональности
- `Устарело` - для функциональности, которая скоро будет удалена
- `Удалено` - для удаленной функциональности
- `Исправлено` - для исправлений багов
- `Безопасность` - в случае уязвимостей
